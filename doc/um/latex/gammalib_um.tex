%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%                             GammaLib User Manual
%
% Version: 0.5
% Last modification: 10 February 2012
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Definitions for manual package
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newcommand{\task}{\mbox{GammaLib}}
\newcommand{\this}{\mbox{\tt \task}}
\newcommand{\version}{\mbox{0.5.0}}
\newcommand{\calendar}{\mbox{10 February 2012}}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Document definition
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\documentclass{article}[12pt,a4]
\usepackage{epsfig}
\usepackage{manual}
\usepackage{makeidx}
\usepackage{hyperref}
\makeindex


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Other definitions
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newcommand{\swigversion}{\mbox{2.0.4}}
\newcommand{\cfitsio}{\mbox{\tt cfitsio}}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Begin of document body
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{document}
\frontpage


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Introduction
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Introduction}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Scope}

This User Manual provides a complete description of the \this\ C++ library.
It is equally well suited for beginners as well as experienced users.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Overview}

\this\ is a self-contained, instrument independent, open source, multi-platform C++ library
that implements all code required for the scientific analysis of astronomical gamma-ray 
data.
\this\ works with high-level data, which are data that are already calibrated and that generally
come in form of event lists or histograms.

\this\ does not rely on any third-party software, with the only
exception of the {\tt cfitsio} library from HEASARC that is used to implement the FITS interface.
This makes \this\ basically independent of any other software package,
increasing the maintainability and enhancing the portability of the library.

\this\ potentially supports any gamma-ray astronomy instrument.
Large parts of the code treat gamma-ray observations in an abstract representation, and do
neither depend on the characteristics of the employed instrument, nor on the particular
formats in which data and instrument response functions are delivered.
Instrument specific aspects are implemented as isolated and well defined modules that
interact with the rest of the library through a common interface.
This philosophy also enables the joint analysis of data from different instruments, providing
a framework that allows for consistent broad-band spectral fitting or imaging.

\this\ source code is freely available under the GNU General Public license version 3.
The latest source code can be downloaded from 
\url{https://sourceforge.net/projects/gammalib/}
which also provides bug trackers and mailing lists.
Further information and documentation on \this\ can be found on
\url{http://gammalib.sourceforge.net/}.
The present document applies to \this\ version \version.

\this\ is designed to compile on any POSIX compliant platform.
So far, \this\ has been successfully compiled and tested on Mac OS X, OpenBSD,
OpenSolaris (using the gcc compiler) and many Linux flavours.
Pre-packed binary versions of the code are also available for Mac OS X.
For known problems with specific platforms, please refer to 
section \ref{sec:knownproblems}.

\this\ makes heavily use of C++ classes.
Instrument independency is achieved by using abstract virtual base classes, which are
implemented as derived classes in the instrument specific modules.

\this\ is organized into four software layers, each of which comprises a number of modules
(see Fig.~\ref{fig:structure}; the quoted module names correspond to the folders in the
source code distribution):
\begin{itemize}
\item {\bf High-level analysis support} implements classes needed for the instrument 
independent high-level analysis of gamma-ray data, enabling the joint multi-instrument 
spectral and spatial fitting by forwards folding of parametric source and background models.
This layer comprises modules for 
instrument independent handling of observations ({\tt obs}), 
sky and background models ({\tt model}), 
sky maps and sky coordinates ({\tt sky}), 
and for the generation of analysis executables in form of ftools ({\tt app}).
%
\item {\bf Instrument specific modules} support the analysis of data from
the Cherenkov Telescope Array ({\tt cta}), 
the {\em Fermi}/LAT telescope ({\tt lat}), 
and any multi-wavelength information in form of spectral data points ({\tt mwl}).
%
\item {\bf Core services} comprise modules for 
numerical computations ({\tt numerics}),
linear algebra ({\tt linalg}), 
parameter optimization ({\tt opt}), 
and support functions and classes ({\tt support}).
%
\item {\bf Interfaces} are implemented for reading and writing of 
FITS files ({\tt fits}) 
and XML files ({\tt xml}).
\end{itemize}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{figure*}[!t]
 \center
 \epsfig{figure=structure.eps, height=12cm}
 \caption{Organisation of \this\ into software layers and modules.}
 \label{fig:structure}
\end{figure*}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\this\ can be used as C++ application program interface (API) or as a Python module (provided
that Python is installed on your system).
The \this\ Python bindings were built using 
{\tt swig} version \swigversion\ (\url{http://www.swig.org/}), and are shipped together with the
source code.
This enables using all \this\ functionalities from within Python.

The development of \this\ has been initiated by scientists from IRAP (Institut de Recherche
en Astrophysique et Plan\'etologie), an astrophysics laboratory of CNRS and of the University
Paul Sabatier situated in Toulouse, France.
\this\ is based on past experience gained in developing software for gamma-ray space
missions, such as
the COMPTEL telescope aboard {\em CGRO}, 
the SPI telescope aboard {\em INTEGRAL},
and the LAT telescope aboard {\em Fermi}.
Initial elements of \this\ can be found in the {\tt spi\_toolslib} that is part of the
Off-line Science Analysis (OSA) software distributed by ISDC for the science analysis 
of {\em INTEGRAL} data.
The development of \this\ is nowadays mainly driven by the advances in 
ground-based gamma-ray astronomy, and in particular by the development of the
CTA observatory.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Getting GammaLib
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\clearpage
\section{Getting \this}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Before you start}

The procedure for building and installing \this\ is modeled on GNU software distributions.
You do not need to have system administrator privileges to compile and to install \this.

You will need the following to build the software:
\begin{itemize}
\item About 100 MB of free disk space.
\item An ANSI C++ compiler. We recommend building \this\ with the GNU g++ compiler.
\item GNU make
\item The {\tt cfitsio} library for FITS file support together with the developer package that 
includes the {\tt cfitsio.h} header.
\end{itemize}
Note that \this\ compiles also in the absence of the {\tt cfitsio} library, yet without {\tt cfitsio},
FITS file reading or writing is not supported.

Furthermore, the following optional packages are supported but are not required to compile \this:
\begin{itemize}
\item Python, including the Python developer package that includes the {\tt Python.h} header
file. 
If Python is present, the \this\ Python module will be built and installed, allowing to script all 
\this\ functionalities from within Python.
\item {\tt readline}, including the {\tt readline} developer package that provides
the {\tt readline.h} header file.
If {\tt readline} is present, the packages are used to enhance the user interface
when entering parameters for ftools applications (see section \ref{sec:app}).
\end{itemize}
If you plan to modify or to extend the \this\ source code, the following software is also
required on your system:
\begin{itemize}
\item GNU {\tt autoconf} (\url{http://www.gnu.org/software/autoconf/}) and {\tt automake}
(\url{http://www.gnu.org/software/automake/}) is needed to rebuild the {\tt configure}
script and {\tt Makefile.am} resource files following configuration modifications.
\item {\tt swig} (\url{http://www.swig.org/}) is needed to rebuild the Python wrappers following
Python interface modifications. Make sure to install the latest {\tt swig} version (\swigversion)
to guarantee the largest possible compatibility of the Python wrappers.
\item Doxygen (\url{http://www.doxygen.org/}) is needed to rebuild the software reference
manual following code modifications.
\end{itemize}
The following sections provide some information about the installation of {\tt cfitsio} and
{\tt readline}.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{Installing {\tt cfitsio}}
\label{sec:cfitsio}

HEASARC's {\tt cfitsio} library comes on many Linux distributions as pre-compiled binary,
and there are good chances that the package is already installed on your system.
For Mac OS X, {\tt cfitsio} can be installed from Mac Ports.
If you use a pre-compiled binary, make sure that also the developer package
is installed on your system.
The developer package provides the {\tt cfitsio.h} header file which is needed to compile
in FITS file support in \this.
Please refer to the documentation of your Linux distribution to learn how to install
pre-compiled binary packages (note that the installation of pre-compiled binary packages 
usually requires system administrator privileges).

If you need (or prefer) to install {\tt cfitsio} from source, you can download the latest source
code from \url{http://heasarc.gsfc.nasa.gov/fitsio}.
Detailed installation instructions can also be found on this site.
We recommend that you install {\tt cfitsio} as a shared library in the same directory in which
you will install \this, so that {\tt cfitsio} is automatically found by the \this\ {\tt configure} script.
By default, \this\ gets installed into the directory {\tt /usr/local/gamma}.

You can install version 3.290 of {\tt cfitsio} (the latest version that was available during writing 
this manual) by executing the following command sequence 
({\tt >} denotes the UNIX shell prompt):
\begin{verbatim}
> wget ftp://heasarc.gsfc.nasa.gov/software/fitsio/c/cfitsio3290.tar.gz
> tar xfz cfitsio3290.tar.gz
> cd cfitsio
> ./configure --prefix=/usr/local/gamma
> make shared
> sudo make install
\end{verbatim}
The {\tt --prefix=/usr/local/gamma} option specifies the directory into which {\tt cfitsio} gets
installed.
We choose here the default \this\ installation directory {\tt /usr/local/gamma}.
As this directory is a system directory, we need to use {\tt sudo} for installation.
If you decide to install {\tt cfitsio} into a local directory which is owned by yourself, it
is sufficient to type {\tt make install} to install the library.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{Installing {\tt readline}}

{\tt readline} comes on all Linux distributions that are known to us as pre-compiled binary, 
and it is almost certain that {\tt readline} is already installed on your system.
Very often, however, the {\tt readline} developer package that provides the {\tt readline.h}
header file is not installed, and you need to install this package yourself to enable
{\tt readline} support for \this.
Please refer to the documentation of your Linux distribution to learn how to install
pre-compiled binary packages (note that the installation of pre-compiled binary packages 
usually requires system administrator privileges).

If you need (or prefer) to install {\tt readline} from source, you need also to install the
{\tt ncurses} library that is required by {\tt readline}.
Here is the command line sequence that will install 
{\tt ncurses} (version 5.9) and 
{\tt readline} (version 6.2)
in the \this\ default install directory {\tt /usr/local/gamma} from source
({\tt >} denotes the UNIX shell prompt):
\begin{verbatim}
> wget http://ftp.gnu.org/gnu/ncurses/ncurses-5.9.tar.gz
> tar xfz ncurses-5.9.tar.gz
> cd ncurses-5.9
> ./configure --prefix=/usr/local/gamma
> make
> sudo make install
> cd ..
> wget http://ftp.gnu.org/gnu/readline/readline-6.2.tar.gz
> tar xfz readline-6.2.tar.gz
> cd readline-6.2
> ./configure --prefix=/usr/local/gamma
> make
> sudo make install
\end{verbatim}
Note that {\tt sudo} is only needed if you are not the owner of the install directory.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Installing \this}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{Downloading \this}

To get the latest version of \this, please visit the site \url{https://sourceforge.net/projects/gammalib/}.
The code can be downloaded from this site by clicking on the download
button.
Alternatively, the code can be downloaded and unpacked from the UNIX prompt using
 ({\tt >} denotes the UNIX shell prompt):
\begin{verbatim}
> wget --no-check-certificate https://downloads.sourceforge.net/project/gammalib/
gammalib/gammalib-00-05-00.tar.gz
> tar xfz gammalib-00-05-00.tar.gz
\end{verbatim}

The \this\ source code can also be cloned using {\tt git}.
This method is recommended if you plan to contribute to the development of the \this\ library.
Assuming that {\tt git} is installed on your system, you may clone \this\ using:
\begin{verbatim}
> git clone git://gammalib.git.sourceforge.net/gitroot/gammalib/gammalib
\end{verbatim}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{Configuring \this}
\label{sec:configure}

Once you've downloaded and uncompressed \this, step into the \this\ source code directory 
and type
\begin{verbatim}
> ./configure
\end{verbatim}
to configure the library for compilation.
Make sure that you type {\tt ./configure} and not simply {\tt configure} to ensure that the 
configuration script in the current directory is invoked and not some other system-wide 
configuration script.

If you would like to install \this\ in a different directory, use the optional {\tt --prefix} argument 
during the configuration step.
For example
\begin{verbatim}
> ./configure --prefix=/home/myname/gamma
\end{verbatim}
installs \this\ in the {\tt gamma} directory that will be located in the user's {\tt myname} home 
directory.
You can obtain a full list of configuration options using
\begin{verbatim}
> ./configure --help
\end{verbatim}

If configuration was successful, the script will terminate with printing information about
the configuration.
This information is important in case that you encounter installation problems, and may help
you to diagnose the problems.
The typical output that you may see is as follows:
\begin{verbatim}
  GammaLib configuration summary
  ==============================
  * FITS I/O support             (yes)   /usr/local/gamma/lib /usr/local/gamma/include
  * Readline support             (yes)    
  * Ncurses support              (yes)   
  * Python                       (yes)
  * Python.h                     (yes)
  * swig                         (yes)
  * Make Python bindings         (yes)
  * Multiwavelength interface    (yes)
  * Fermi-LAT interface          (yes)
  * CTA interface                (yes)
  * Doxygen                      (yes)   /usr/local/bin/doxygen
  * Perform NaN/Inf checks       (yes)   (default)
  * Perform range checking       (yes)   (default)
  * Optimize memory usage        (yes)   (default)
  - Compile in debug code        (no)    (default)
  - Enable code for profiling    (no)    (default)
\end{verbatim}
The script informs whether {\tt cfitsio} has been found (and eventually also gives the
directories in which the {\tt cfitsio} library and the header file resides), whether {\tt readline}
and {\tt ncurses} have been found, and whether Python including the {\tt Python.h}
header file is available.
Although none of these items is mandatory, we highly recommend to install {\tt cfitsio}
to support FITS file reading and writing (see section \ref{sec:cfitsio}), and to install
Python to enable \this\ scripting.

If {\tt cfitsio} is installed on your system but not found by the {\tt configure} script, it may
be located in a directory that is not known to the {\tt configure} script.
By default, {\tt configure} will search for {\tt cfitsio} (in the given order) in the
\this\ install directory,
in all standard paths (e.g. {\tt /usr/lib}, {\tt /usr/local/lib}, ...), and
in some system specific locations, including {\tt /opt/local/lib} for Mac OS X.
Assuming that you installed {\tt cfitsio} on your system in the directory {\tt /home/myname/cfitsio},
you may explicitly specify this location to {\tt configure} using the {\tt LDFLAGS} and
{\tt CPPFLAGS} environment variables:
\begin{verbatim}
> ./configure LDFLAGS=-L/home/myname/cfitsio/lib CPPFLAGS=-I/home/myname/cfitsio/include
\end{verbatim}
Here, {\tt LDFLAGS} specifies the path where the shared {\tt cfitsio} library is located, while
{\tt CPPFLAGS} specifies the path where the {\tt cfitsio.h} header file is located.
Note that {\tt -L} has to prefix the library path and that {\tt -I} has to prefix the header
file path.
With the same method, you may specify any non-standard location for the {\tt readline} and 
{\tt ncurses} libraries.

The configuration script also checks for the presence of {\tt swig}, which is used for building
the Python wrapper files.
Normally, {\tt swig} is not needed to create the Python bindings as the necessary wrapper
files are shipped with the \this\ source code.
If you plan, however, to modify or to extend the Python interface, you will need {\tt swig} to rebuild
the Python wrappers following changes to the interface.

The configuration summary informs also about all instrument dependent interfaces that will be
compiled into the \this\ library.
By default, all available interfaces (multi-wavelength, {\em Fermi}-LAT, and CTA)
will be compiled into \this.
If you wish to disable a particular interface, you may use the {\tt configure} options
{\tt --without-mwl},
{\tt --without-lat}, or
{\tt --without-cta}.
For example,
\begin{verbatim}
> ./configure --without-mwl --without-lat
\end{verbatim}
will compile \this\ without the multi-wavelength and the {\em Fermi}-LAT interfaces.
In this case, only CTA data analysis will be supported.

\this\ uses Doxygen (\url{http://www.doxygen.org/}) for code documentation, and the latest
\this\ reference manual can be found at
\url{http://gammalib.sourceforge.net/doxygen/}.
In case that you want to install the reference manual also locally on your machine, Doxygen
is needed to create the reference manual from the source code.
Doxygen is also needed if you plan to modify or extend the \this\ library to allow rebuilding
the reference documentation after changes.
Please read see section \ref{sec:doxygen} to learn how to build and to install the reference
manual locally.

Finally, there exist a number of options that define how exactly \this\ will be compiled.

Several methods are able to detect invalid floating point values (either {\tt NaN} or {\tt Inf}),
and by default, these checks will be compiled in the library to track numerical problems.
If you want to disable these checks, you may specify the {\tt --disable-nan-check} option
during configuration.

Range checking is performed by default on all indices that are provided to methods or
operators (such as vector or matrix element indices, sky pixels, event indices, etc.), at the 
expense of a small speed penalty that arises from these verifications. 
You may disable these range checkings by specifying the {\tt --disable-range-check}
option during configuration.

In a few places there exists a trade-off between speed and memory requirements, and a choice
has to be made whether faster execution or smaller memory allocation should be preferred.
By default, smaller memory allocation is preferred by \this, but if you are not concerned about
memory allocation you may specify the {\tt --disable-small-memory} option during
configuration to speed up the code.

If you develop code for \this\ you may be interested in adding some special debugging code, 
and this debugging code can be compiled in the library by specifying the
{\tt --enable-debug} option during configuration.
By default, no debugging code will be added to \this.

Another developer option concerns profiling, which may be of interest to optimize the
execution time of your code.
If you would like to add profiling information to the code (which will be at the expense of
execution time), you may specify the {\tt --enable-profiling} option during configuration,
which adds the {\tt -pg} flags to the compiler.
By default, profiling is disabled for \this.

\paragraph{Mac OS X options.}
The Mac OS X environment is special in that it supports different CPU architectures (intel, ppc)
and different addressing schemes (32-bit and 64-bit).
To cope with different system versions and architectures, you can build a universal binary
by using the option
\begin{verbatim}
> ./configure --enable-universalsdk[=PATH]
\end{verbatim}
The optional argument {\tt PATH} specifies which OSX SDK should be used to perform the 
build.
By default, the SDK {\tt /Developer/SDKs/MacOSX.10.4u.sdk} is used.
If you want to build a universal binary on Mac OS X 10.5 or higher, and in particular if you build
64-bit code, you have to specify {\tt --enable-universalsdk=/}.

A second option (which is only valid in combination with the {\tt --enable-universalsdk})
allows to specify the kind of universal build that should be created:
\begin{verbatim}
> ./configure --enable-universalsdk[=PATH] --with-univeral-archs=VALUE
\end{verbatim}
Possible options for {\tt VALUE} are: 
{\tt 32-bit},
{\tt 3-way},
{\tt intel}, or
{\tt all}.
By default, a 32-bit build will be made.

These options are in particular needed if your Python architecture differs
from the default architecture of your system.
To examine the Python architecture you may type:
\begin{verbatim}
> file `which python`
\end{verbatim}
which will return the architectures that are compiled in the Python executable:
\begin{verbatim}
  i386     32-bit intel
  ppc      32-bit powerpc
  ppc64    64-bit powerpc
  x86_64   64-bit intel
\end{verbatim}
If Python is 32-bit ({\tt ppc}, {\tt i386}) but the compiler produces by default
64-bit code ({\tt ppc64}, {\tt x86\_64}), the Python module will not work.
Using
\begin{verbatim}
> ./configure --enable-universalsdk=/
\end{verbatim}
will force a universal 32-bit build which creates code for {\tt ppc} and 
{\tt i386} architectures.
If on the other hand Python is 64-bit ({\tt ppc64}, {\tt x86\_64}) but the
compiler produces by default 32-bit code ({\tt ppc}, {\tt i386}), the option
\begin{verbatim}
> ./configure --enable-universalsdk=/ --with-univeral-archs=3-way
\end{verbatim}
will generate a universal build which contains 32-bit and 64-bit code.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{Building \this}

Once configured you can build \this\ by typing
\begin{verbatim}
> make
\end{verbatim}
This compiles all \this\ code, including the Python wrappers, and builds the dynamic \this\
library and Python module.

\this\ building can profit from multi-processor or multi-core machines by performing
parallel compilation of source code within the modules.
You can enable this feature by typing
\begin{verbatim}
> make -j<n>
\end{verbatim}
where {\tt <n>} is a number that should be twice the number of cores or processors that
are available on your machine.

In case that you rebuild \this\ after changing the configuration, we recommend to clean the
directory from any former build by typing
\begin{verbatim}
> make clean
\end{verbatim}
prior to {\tt make}.
This will remove all existing object and library files from the source code directory, allowing for
a fresh clean build of the library.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{Testing \this}

\this\ comes with an extensive unit test that allows to validate the library prior to installation.
{\bf We highly recommend to run this unit test before installing the library (see section \ref{sec:install}).}

To run the unit test type:
\begin{verbatim}
> make check
\end{verbatim}
This will start a test of all \this\ modules by using dedicated executables which will print some
progress and success information into the terminal.
After completion of all tests (and assuming that all instrument dependent modules are enabled),
you should see the following message in your terminal:
\begin{verbatim}
===================
All 15 tests passed
===================
\end{verbatim}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{Installing \this}
\label{sec:install}

\this\ is finally installed by typing
\begin{verbatim}
> sudo make install
\end{verbatim}
By default, \this\ is installed in the system directory {\tt /usr/local/gamma}, hence
{\tt sudo} needs to be prepended to enable writing in a system-level directory.
If you install \this, however, in a local directory of which you are the owner, or if you install
\this\ under {\tt root}, you may simply specify {\tt make install} to initiate the installation
process.

The installation step will copy all necessary files into the installation directory.
Information will be copied in the following subdirectories:
\begin{itemize}
\item {\tt bin} contains \this\ environment configuration scripts (see section \ref{sec:environment})
\item {\tt include} contains \this\ header files (subdirectory {\tt gammalib})
\item {\tt lib} contains the \this\ library and Python module
\item {\tt share} contains addition \this\ information, such as a calibration database
(subdirectory {\tt caldb}), documentation (subdirectory {\tt doc}), and Python interface
definition files (subdirectory {\tt gammalib/swig})
\end{itemize}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{Setting up the \this\ environment}
\label{sec:environment}

Before using \this\ you have to setup some environment variables. 
This will be done automatically by an initialisation script that has been installed in the {\tt bin} 
subdirectory of the install directory. 
Assuming that you have installed GammaLib in the default directory {\tt /usr/local/gamma} you
need to add the following to your {\tt \$HOME/.bashrc} or {\tt \$HOME/.profile} script on a Linux 
machine:
\begin{verbatim}
export GAMMALIB=/usr/local/gamma
source $GAMMALIB/bin/gammalib-init.sh
\end{verbatim}

If you use C shell or a variant then add the following to your {\tt \$HOME/.cshrc} or {\tt \$HOME/.tcshrc}
script:
\begin{verbatim}
setenv GAMMALIB /usr/local/gamma
source $GAMMALIB/bin/gammalib-init.csh
\end{verbatim}

You then have to source your initialisation script by typing (for example)
\begin{verbatim}
> source $HOME/.bashrc
\end{verbatim}
and all environment variables are set correctly to use \this\ properly.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{Generating the reference documentation}
\label{sec:doxygen}

The reference documentation for \this\ is generated directly from the source code using
the Doxygen documentation system (\url{http://www.doxygen.org/}).
The latest \this\ reference manual can be found at 
\url{http://gammalib.sourceforge.net/doxygen/}.

The reference documentation is not shipped together with the source code as this
would considerably increase the size of the tarball.
In case that you want to install the reference manual also locally on your machine, you
first have to create the documentation using Doxygen.

Assuming that Doxygen is available on your machine (see section \ref{sec:configure})
you can create the reference documentation by typing
\begin{verbatim}
> make doxygen
\end{verbatim}
Once created, you can install the reference manual by typing
\begin{verbatim}
> sudo make doxygen-install
\end{verbatim}
By default, \this\ is installed in the system directory {\tt /usr/local/gamma}, hence
{\tt sudo} needs to be prepended to enable writing in a system-level directory.
If you install \this, however, in a local directory of which you are the owner, or if you install
\this\ under {\tt root}, you may simply specify {\tt make install} to initiate the installation
process.

The reference manual will be installed in form of web-browsable HTML files into
the folder
\begin{verbatim}
  /usr/local/gamma/share/doc/gammalib/html/doxygen
\end{verbatim}
You can access all web-based \this\ documentation locally using
\url{file:///usr/local/gamma/share/doc/gammalib/html/index.html}
(assuming that the \this\ library has been installed in the default directory {\tt /usr/local/gamma}).

In addition, the reference manual will also be available as man pages that will be installed
into
\begin{verbatim}
  /usr/local/gamma/share/doc/gammalib/man
\end{verbatim}
To access for example the information for the {\tt GApplication} class, you can type
\begin{verbatim}
> man GApplication
\end{verbatim}
which then returns the synopsis and detailed documentation for the requested class.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Getting support}

Any question, bug report, or suggested enhancement related to \this\ should be submitted
via the Tracker on 
\url{https://sourceforge.net/projects/gammalib/}
or by sending an e-mail to the\break
{\tt gammalib-users@lists.sourceforge.net}
mailing list.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Known problems}
\label{sec:knownproblems}

Mac OS X 10.7 (Lion) replaces the GNU g++ compiler by the clang compiler
(\url{http://clang.llvm.org/}).
\this\ compiles successfully on this compiler, but it appears that exceptions thrown by
\this\ are not correctly catched by the application linking \this.
This seems to be a bug (or a feature) of the clang compiler.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Getting started (for novice users)
%
% Present an informal introduction to the system, describing its 'normal' usage. It should describe how
% to get started and how end-users might make use of the common system facilities. The section
% should be liberally illustrated with examples. Inevitably, beginners will make mistakes. Easily
% discovered information on how to recover from these mistakes and restart useful work should be
% an integral part of this section.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\clearpage
\section{Getting started with \this}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{A quick \this\ tutorial}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%\subsection{Models available in \this}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Using \this\ from Python}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Programming guidelines}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Frequently asked questions}






%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% GammaLib modules (for experienced users)
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\clearpage
\section{\this\ modules}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{High-level analysis support}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{{\tt app} - Creation of ftools applications}
\label{sec:app}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{{\tt obs} - Observation handling}
\label{sec:obs}

The primary user interface for the analysis of gamma-ray data is implemented by
the container class {\tt GObservations}.
{\tt GObservations} collects a list of gamma-ray observations which are the basic
entity used

The basic entity used for analysis of gamma-ray data is an observation.
{\bf TBW: Define what an observation is: single instrument, specific response function}.

An observation is implemented by the abstract {\tt GObservation} class that provides
the instrument independent interface to the data.

To combine several observation for an analysis, a list of {\tt GObservation} objects is
gather by the container class {\tt GObservations}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{{\tt model} - Model handling}
\label{sec:model}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{{\tt sky} - Sky maps and sky coordinates}
\label{sec:sky}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Core services}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{{\tt numerics} - Numerical methods}
\label{sec:numerics}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{{\tt linalg} - Linear algebra}
\label{sec:linalg}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{{\tt opt} - Optimizers}
\label{sec:opt}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{{\tt support} - Support functions and classes}
\label{sec:support}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Interfaces}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{{\tt fits} - FITS file interface}
\label{sec:fits}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{{\tt xml} - XML file interface}
\label{sec:xml}



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Users manual (for experienced users)
%
% This section should decribe the system facilities and their usage, should provide a complete listing
% of error messages and should describe how to recover from them. It should be complete. Formal
% descriptive techniques may be used. Completeness is more important that readability.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\clearpage
\section{Users manual}

This section provides a detailed list ...

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Linear algebra}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{Vectors}

%----------------------------------------------------------------------------
\paragraph{General}

A vector is a one-dimensional array of successive {\tt double} type values.
Vectors are handled in \this\ by {\tt GVector} objects.
On construction, the dimension of the vector has to be specified.
In other words
\begin{verbatim}
 GVector vector;                        // WRONG: constructor needs dimension
\end{verbatim}
is not allowed.
The minimum dimension of a vector is 1, i.e. there is no such thing 
like an empty vector:
\begin{verbatim}
 GVector vector(0);                     // WRONG: empty vector not allowed
\end{verbatim}
The correct allocation of a vector is done using
\begin{verbatim}
 GVector vector(10);                    // Allocates a vector with 10 elements
\end{verbatim}
On allocation, all elements of a vector are set to 0.
Vectors may also be allocated by copying from another vector
\begin{verbatim}
 GVector vector(10);                    // Allocates a vector with 10 elements
 GVector another = vector;              // Allocates another vector with 10 elements
\end{verbatim}
or by using 
\begin{verbatim}
 GVector vector = GVector(10);          // Allocates a vector with 10 elements
\end{verbatim}

Vector elements are accessed using the {\tt ( )} operator:
\begin{verbatim}
 GVector vector(10);                    // Allocates a vector with 10 elements
 for (int i = 0; i < 10; ++i)
   vector(i) = (i+1)*10.0;              // Set elements 10, 20, ..., 100
 for (int i = 0; i < 10; ++i)
   cout << vector(i) << endl;           // Dump all elements, one by row 
\end{verbatim}
The content of a vector may also be dumped using
\begin{verbatim}
 cout << vector << endl;                // Dump entire vector
\end{verbatim}
which in the above example will put the sequence
\begin{verbatim}
 10 20 30 40 50 60 70 80 90 100
\end{verbatim}
on the screen.


%----------------------------------------------------------------------------
\paragraph{Vector arithmetics}

Vectors can be very much handled like {\tt double} type variables
with the difference that operations are performed on each element of 
the vector.
The complete list of fundamental vector operators is:
\begin{verbatim}
 c = a + b;                             // Vector + Vector addition
 c = a + s;                             // Vector + Scalar addition
 c = s + b;                             // Scalar + Vector addition
 c = a - b;                             // Vector - Vector subtraction
 c = a - s;                             // Vector - Scalar subtraction
 c = s - b;                             // Scalar - Vector subtraction
 s = a * b;                             // Vector * Vector multiplication (dot product)
 c = a * s;                             // Vector * Scalar multiplication
 c = s * b;                             // Scalar * Vector multiplication
 c = a / s;                             // Vector * Scalar division
\end{verbatim}
where {\tt a}, {\tt b} and {\tt c} are of type {\tt GVector} and 
{\tt s} is of type {\tt double}.
Note in particular the combination of {\tt GVector} and {\tt double} 
type objects in addition, subtraction, multiplication and division.
In these cases the specified operation is applied to each of the 
vector elements.
It is also obvious that only vector of identicial dimension can occur 
in vector operations.
Dimension errors can be catched by the {\tt try} - {\tt catch} 
functionality:
\begin{verbatim}
 try {
   GVector a(10);                       
   GVector b(11);
   GVector c = a + b;                   // WRONG: Vectors have incompatible dimensions
 }
 catch (GVector::vector_mismatch &e) {
   cout << e.what() << endl;            // Dimension exception is catched here
   throw;
 }
\end{verbatim}
Further vector operations are
\begin{verbatim}
 c = a;                                 // Vector assignment
 c = s;                                 // Scalar assignment
 s = c(index);                          // Vector element access
 c += a;                                // c = c + a;
 c -= a;                                // c = c - a;
 c += s;                                // c = c + s;
 c -= s;                                // c = c - s;
 c *= s;                                // c = c * s;
 c /= s;                                // c = c / s;
 c = -a;                                // Vector negation
\end{verbatim}
Finally, the comparison operators
\begin{verbatim}
 int equal   = (a == b);                // True if all elements equal
 int unequal = (a != b);                // True if at least one elements unequal
\end{verbatim}
allow to compare all elements of a vector. If all elements are
identical, the {\tt ==} operator returns true, otherwise false.
If at least one element differs, the {\tt !=} operator returns true, 
is all elements are identical it returns false.

In addition to the operators, the following mathematical functions 
can be applied to vectors:
\begin{verbatim}
    acos         atan         exp          sin          tanh
    acosh        atanh        fabs         sinh
    asin         cos          log          sqrt
    asinh        cosh         log10        tan
\end{verbatim}
Again, these functions should be understood to be applied element wise.
They all take a vector as argument and produce a vector as result.
For example
\begin{verbatim}
 c = sin(a);
\end{verbatim}
attributes the sine of each element of vector {\tt a} to vector 
{\tt c}.
Additional implemented functions are
\begin{verbatim}
 c = cross(a, b);                       // Vector cross product (for 3d only)
 s = norm(a);                           // Vector norm |a|
 s = min(a);                            // Minimum element of vector
 s = max(a);                            // Maximum element of vector
 s = sum(a);                            // Sum of vector elements
\end{verbatim}
Finally, a small number of vector methods have been implemented:
\begin{verbatim}
 int n = a.size();                      // Returns dimension of vector
 int n = a.non_zeros();                 // Returns number of non-zero elements in vector
\end{verbatim}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{Matrixes}

%----------------------------------------------------------------------------
\paragraph{General}

A matrix is a two-dimensional array of {\tt double} type values, 
arranged in rows and columns.
Matrixes are handled in \this\ by {\tt GMatrix} objects and the 
derived classes {\tt GSymMatrix} and {\tt GSparseMatrix} (see section 
\ref{sec:matrix:storage}).
On construction, the dimension of the matrix has to be specified:
\begin{verbatim}
 GMatrix matrix(10,20);                 // Allocates 10 rows and 20 columns
\end{verbatim}
Similar to vectors, there is no such thing as a matrix without 
dimensions in \this.


%----------------------------------------------------------------------------
\paragraph{Matrix storage classes}
\label{sec:matrix:storage}

In the most general case, the {\tt rows} and {\tt columns} of a 
matrix are stored in a continuous array of 
${\tt rows} \times {\tt columns}$
memory locations.
This storage type is referred to as a {\em full matrix}, and is 
implemented by the class {\tt GMatrix}.
Operations on full matrixes are in general relatively fast, but 
memory requirements may be important to hold all the elements.
In general matrixes are stored by \this\ column-wise (or in 
column-major format).
For example, the matrix
\begin{verbatim}
    1  2  3  4  5
    6  7  8  9 10
   11 12 13 14 15 
\end{verbatim}
is stored in memory as
\begin{verbatim}
    |  1  6 11 |  2  7 12 |  3  8 13 |  4  9 14 |  5 10 15 |
\end{verbatim}

Many physical or mathematical problems treat with a subclass of 
matrixes that is symmetric, i.e. for which the element
{\tt (row,col)} is identical to the element {\tt (col,row)}.
In this case, the duplicated elements need not to be stored.
The derived class {\tt GSymMatrix} implements such a storage type.
{\tt GSymMatrix} stores the lower-left triangle of the matrix in 
column-major format.
For illustration, the matrix
\begin{verbatim}
    1  2  3  4
    2  5  6  7
    3  6  8  9
    4  7  9 10
\end{verbatim}
is stored in memory as
\begin{verbatim}
    |  1  2  3  4 |  5  6  7 |  8  9 | 10 |
\end{verbatim}
This divides the storage requirements to hold the matrix elements by 
almost a factor of two.

Finally, quite often one has to deal with matrixes that contain a 
large number of zeros.
Such matrixes are called {\em sparse matrixes}.
If only the non-zero elements of a sparse matrix are stored the memory 
requirements are considerably reduced.
This goes however at the expense of matrix element access, which has 
become now more complex.
In particular, filling efficiently a sparse matrix is a non-trivial 
problem (see section \ref{sec:matrix:filling}).
Sparse matrix storage is implemented in \this\ by the derived class 
{\tt GSparseMatrix}.
A {\tt GSparseMatrix} object contains three one-dimensional arrays to 
store the matrix elements: 
a {\tt double} type array that contains in continuous column-major order 
all non-zero elements, 
an {\tt int} type array that contains for each non-zero element the 
row number of its location, and
an {\tt int} type array that contains the storage location of the 
first non-zero element for each matrix column.
To illustrate this storage format, the matrix
\begin{verbatim}
    1  0  0  7
    2  5  0  0
    3  0  6  0
    4  0  0  8
\end{verbatim}
is stored in memory as 
\begin{verbatim}
    |  1  2  3  4 |  5 |  6 |  7  8 |  Matrix elements
    |  0  1  2  3 |  1 |  2 |  0  3 |  Row indices for all elements
    |  0          |  4 |  5 |  6    |  Storage location of first element of each column
\end{verbatim}
This example is of course not very economic, since the total number of 
Bytes used to store the matrix is 
$8 \times 8 + (8 + 4) \times 4 = 112$ Bytes, while a full $4 \times 4$
matrix is stored in
$(4 \times 4) \times 8 = 128$ Bytes (recall: a {\tt double} type 
values takes 8 Bytes, an {\tt int} type value takes 4 Bytes).
For realistic large systems, however, the gain in memory space can be 
dramatical.

The usage of the {\tt GMatrix}, {\tt GSymMatrix} and {\tt GSparseMatrix} 
classes is analoguous in that they implement basically all functions 
and methods in an identical way.
So from the semantics the user has not to worry about the storage 
class. 
However, matrix element access speeds are not identical for all 
storage types, and if performance is an issue (as it certainly always 
will be), the user has to consider matrix access more carefully
(see section \ref{sec:matrix:filling}).

Matrix allocation is performed using the constructors:
\begin{verbatim}
 GMatrix       A(10,20);                // Full 10 x 20 matrix
 GSymMatrix    B(10,10);                // Symmetric 10 x 10 matrix
 GSparseMatrix C(1000,10000);           // Sparse 1000 x 10000 matrix

 GMatrix       A(0,0);                  // WRONG: empty matrix not allowed
 GSymMatrix    B(20,22);                // WRONG: symmetric matrix requested
\end{verbatim}
In the constructor, the first argument specifies the number of rows, 
the second the number of columns: {\tt A(row,column)}.
A symmetric matrix needs of course an equal number of rows and columns.
And an empty matrix is not allowed.
All matrix elements are initialised to 0 by the matrix allocation.

Matrix elements are accessed by the {\tt A(row,col)} function,
where {\tt row} and {\tt col} start from 0 for the first row or column 
and run up to the number of rows or columns minus 1:
\begin{verbatim}
 for (int row = 0; row < n_rows; ++row) {
   for (int col = 0; col < n_cols; ++col)
     A(row,col) = (row+col)/2.0;        // Set value of matrix element
 }
 ...
 double sum2 = 0.0;
 for (int row = 0; row < n_rows; ++row) {
   for (int col = 0; col < n_cols; ++col)
     sum2 *= A(row,col) * A(row,col);   // Get value of matrix element
 }
\end{verbatim}

The content of a matrix can be visualised using
\begin{verbatim}
 cout << A << endl;                     // Dump matrix
\end{verbatim}


%----------------------------------------------------------------------------
\paragraph{Matrix arithmetics}

The following description of matrix arithmetics applies to all storage 
classes (see section \ref{sec:matrix:storage}).
The following matrix operators have been implemented in \this:
\begin{verbatim}
 C = A + B;                             // Matrix Matrix addition
 C = A - B;                             // Matrix Matrix subtraction
 C = A * B;                             // Matrix Matrix multiplication
 C = A * v;                             // Matrix Vector multiplication
 C = A * s;                             // Matrix Scalar multiplication
 C = s * A;                             // Scalar Matrix multiplication
 C = A / s;                             // Matrix Scalar division
 C = -A;                                // Negation
 A += B;                                // Matrix inplace addition
 A -= B;                                // Matrix inplace subtraction
 A *= B;                                // Matrix inplace multiplications
 A *= s;                                // Matrix inplace scalar multiplication
 A /= s;                                // Matrix inplace scalar division
\end{verbatim}
The comparison operators
\begin{verbatim}
 int equal   = (A == B);                // True if all elements equal
 int unequal = (A != B);                // True if at least one elements unequal
\end{verbatim}
allow to compare all elements of a matrix. 
If all elements are identical, the {\tt ==} operator returns true, 
otherwise false.
If at least one element differs, the {\tt !=} operator returns true, 
is all elements are identical it returns false.


%----------------------------------------------------------------------------
\paragraph{Matrix methods and functions}

A number of methods has been implemented to manipulate matrixes.
The method
\begin{verbatim}
 A.clear();                             // Set all elements to 0
\end{verbatim}
sets all elements to 0.
The methods
\begin{verbatim}
 int rows = A.rows();                   // Returns number of rows in matrix
 int cols = A.cols();                   // Returns number of columns in matrix
\end{verbatim}
provide access to the matrix dimensions, the methods
\begin{verbatim}
 double sum = A.sum();                  // Sum of all elements in matrix
 double min = A.min();                  // Returns minimum element of matrix
 double max = A.max();                  // Returns maximum element of matrix
\end{verbatim}
inform about some matrix properties.
The methods
\begin{verbatim}
 GVector v_row    = A.extract_row(row); // Puts row in vector
 GVector v_column = A.extract_col(col); // Puts column in vector
\end{verbatim}
extract entire rows and columns from a matrix.
Extraction of lower or upper triangle parts of a matrix into another
is performed using
\begin{verbatim}
 B = A.extract_lower_triangle();        // B holds lower triangle
 B = A.extract_upper_triangle();        // B holds upper triangle
\end{verbatim}
{\tt B} is of the same storage class as {\tt A}, except for the case 
that {\tt A} is a {\tt GSymMatrix} object. 
In this case, {\tt B} will be a full matrix of type {\tt GMatrix}.

The methods
\begin{verbatim}
 A.insert_col(v_col,col);               // Puts vector in column
 A.add_col(v_col,col);                  // Add vector to column
\end{verbatim}
inserts or adds the elements of a vector into a matrix column.
Note that no row insertion routines have been implemented (so far) 
since they would be less efficient (recall that all matrix types are 
stored in column-major format).

Conversion from one storage type to another is performed using
\begin{verbatim}
 B = A.convert_to_full();               // Converts A -> GMatrix
 B = A.convert_to_sym();                // Converts A -> GSymMatrix
 B = A.convert_to_sparse();             // Converts A -> GSparseMatrix
\end{verbatim}
Note that {\tt convert\_to\_sym()} can only be applied to a matrix that 
is indeed symmetric.

The transpose of a matrix can be obtained by using one of
\begin{verbatim}
 A.transpose();                         // Transpose method
 B = transpose(A);                      // Transpose function
\end{verbatim}

The absolute value of a matrix is provided by
\begin{verbatim}
 B = fabs(A);                           // B = |A|
\end{verbatim}


%----------------------------------------------------------------------------
\paragraph{Matrix factorisations}

A general tool of numeric matrix calculs is factorisation.

Solve linear equation {\tt Ax = b}.
Inverse a matrix (by solving successively {\tt Ax = e}, where {\tt e} 
are the unit vectors for all dimensions).

For symmetric and positive definite matrices the most efficient 
factorisation is the Cholesky decomposition.
The following code fragment illustrates the usage:
\begin{verbatim}
 GMatrix A(n_rows, n_cols};
 GVector x(n_rows};
 GVector b(n_rows};
 ...
 A.cholesky_decompose();                // Perform Cholesky factorisation
 x = A.cholesky_solver(b);              // Solve Ax=b for x
\end{verbatim}
Note that once the function {\tt A.cholesky\_decompose()} has been 
applied, the original matrix content has been replaced by its Cholesky 
decomposition.
Since the Cholesky decomposition can be performed inplace (i.e. 
without the allocation of additional memory to hold the result), the 
matrix replacement is most memory economic.
In case that the original matrix should be kept, one may either copy 
it before into another {\tt GMatrix} object or use the function
\begin{verbatim}
 GMatrix L = cholesky_decompose(A);
 x = L.cholesky_solver(b);
\end{verbatim}

A symmetric and positif definite matrix can be inverted using the 
Cholesky decomposition using
\begin{verbatim}
 A.cholesky_invert();                   // Inverse matrix using Cholesky fact.
\end{verbatim}
Alternatively, the function 
\begin{verbatim}
 GMatrix A_inv = cholesky_invert(A);
\end{verbatim}
may be used.

The Cholesky decomposition, solver and inversion
routines may also be applied to matrices that contain rows or
columns that are filled by zeros.
In this case the functions provide the option to (logically)
compress the matrices by skipping the zero rows and columns during
the calculation.

For compressed matrix Cholesky factorisation, only the non-zero rows 
and columns have to be symmetric and positive definite.
In particular, the full matrix may even be non-symmetric.


%----------------------------------------------------------------------------
\paragraph{Sparse matrixes}

The only exception that does not work is
\begin{verbatim}
 GSparseMatrix A(10,10);
 A(0,0) = A(1,1) = A(2,2) = 1.0;        // WRONG: Cannot assign multiple at once
\end{verbatim}
In this case the value {\tt 1.0} is only assigned to the last 
element, i.e. {\tt A(2,2)}, the other elements will remain
{\tt 0}.
This feature has to do with the way how the compiler translates
the code and how \this\ implements sparse matrix filling.
{\tt GSparseMatrix} provides a pointer for a new element to be 
filled.
Since there is only one such {\em fill pointer}, only one element can 
be filled at once in a statement.
{\bf So it is strongly advised to avoid multiple matrix element 
assignment in a single row.}
Better write the above code like
\begin{verbatim}
 GSparseMatrix A;
 A(0,0) = 1.0;
 A(1,1) = 1.0;
 A(2,2) = 1.0;
\end{verbatim}
This way, element assignment works fine.

Inverting a sparse matrix produces in general a full matrix, so the 
inversion function should be used with caution.
Note that a full matrix that is stored in sparse format takes roughly
twice the memory than a normal {\tt GMatrix} object.
If nevertheless the inverse of a sparse matrix should be examined, it 
is recommended to perform the analysis column-wise:
\begin{verbatim}
 GSparseMatrix A(rows,cols);            // Allocate sparse matrix
 GVector       unit(rows);              // Allocate vector
 ...
 A.cholesky_decompose();                // Factorise matrix

 // Column-wise solving the matrix equation
 for (int col = 0; col < cols; ++col) {
   unit(col) = 1.0;                     // Set unit vector
   GVector x = cholesky_solver(unit);   // Get column x of inverse
   ...
   unit(col) = 0.0;                     // Clear unit vector for next round
 }
\end{verbatim}


%----------------------------------------------------------------------------
\paragraph{Filling sparse matrixes}
\label{sec:matrix:filling}

The filling of a sparse matrix is a tricky issue since the storage
of the elements depends on their distribution in the matrix.
If one would know beforehand this distribution, sparse matrix filling
would be easy and fast.
In general, however, the distribution is not known a priori, and
matrix filling may become a quite time consuming task.

If a matrix has to be filled element by element, the access through
the operator
\begin{verbatim}
 m(row,col) = value;
\end{verbatim}
may be mandatory.
In principle, if a new element is inserted into a matrix a new memory
cell has to be allocated for this element, and other elements may be 
moved.
Memory allocation is quite time consuming, and to reduce the overhead,
{\tt GSparseMatrix} can be configured to allocate memory in bunches.
By default, each time more matrix memory is needed, {\tt GSparseMatrix}
allocates 512 cells at once (or 6144 Bytes since each element requires 
a {\tt double} and a {\tt int} storage location).
If this amount of memory is not adequat one may change this value by
using
\begin{verbatim}
 m.set_mem_block(size);
\end{verbatim}
where {\tt size} is the number of matrix elements that should be
allocated at once (corresponding to a total memory of 
$12 \times {\tt size}$ Bytes).

Alternatively, a matrix may be filled column-wise using the functions
\begin{verbatim}
 m.insert_col(vector,col);              // Insert a vector in column
 m.add_col(vector,col);                 // Add content of a vector to column
\end{verbatim}
While {\tt insert\_col} sets the values of column {\tt col} (deleting 
thus any previously existing entries), {\tt add\_col} adds the content 
of {\tt vector} to all elements of column {\tt col}.
Using these functions is considerably more rapid than filling individual 
values.

Still, if the matrix is big (i.e. severeal thousands of rows and 
columns), filling individual columns may still be slow.
To speed-up dynamical matrix filling, an internal fill-stack has been 
implemented in {\tt GSparseMatrix}.
Instead of inserting values column-by-column, the columns are stored 
in a stack and filled into the matrix once the stack is full.
This reduces the number of dynamic memory allocations to let the 
matrix grow as it is built.
By default, the internal stack is disabled.
The stack can be enabled and used as follows:
\begin{verbatim}
 m.stack_init(size, entries);           // Initialise stack
 ...
 m.add_col(vector,col);                 // Add columns
 ...
 m.stack_destroy();                     // Flush and destory stack
\end{verbatim}
The method {\tt stack\_init} initialises a stack with a number of 
{\tt size} elements and a maximum of {\tt entries} columns.
The larger the values {\tt size} and {\tt entries} are chosen, the
more efficient the stack works.
The total amount of memory of the stack can be estimated as
$12 \times {\tt size} + 8 \times {\tt entries}$ Bytes.
If a rough estimate of the total number of non-zero elements is
available it is recommended to set {\tt size} to this value.
As a rule of thumb, {\tt size} should be at least of the dimension of 
either the number of rows or the number of columns of the matrix 
(take the maximum of both).
{\tt entries} is best set to the number of columns of the matrix.
If memory limits are an issue smaller values may be set, but if the
values are too small, the speed increase may become negligible (or 
stack-filling may even become slower than normal filling).

Stack-filling only works with the method {\tt add\_col}.
Note also that filling sub-sequently the same column leads to stack 
flushing.
In the code
\begin{verbatim}
 for (int col = 0; col < 100; ++col) {
   column      = 0.0;                   // Reset column
   column(col) = col;                   // Set column
   m.add_col(column,col);               // Add column
 }   
\end{verbatim}
stack flushing occurs in each loop, and consequently, the 
stack-filling approach will be not very efficient (it 
would probably be even slover than normal filling).
If successive operations are to be performed on columns, 
it is better to perform them before adding.
The code
\begin{verbatim}
 column = 0.0;                          // Reset column
 for (int col = 0; col < 100; ++col)
   column(col) = col;                   // Set column
 m.add_col(column,col);                 // Add column
\end{verbatim}
would be far more efficient.

A avoidable overhead occurs for the case that the column to be added 
is sparse.
The vector may contain many zeros, and {\tt GSparseMatrix} has to 
filter them out.
If the sparsity of the column is known, this overhead can be avoided 
by directly passing a compressed array to {\tt add\_col}:
\begin{verbatim}
 int     number = 5;                    // 5 elements in array
 double* values = new double[number];   // Allocate values
 int*    rows   = new int[number];      // Allocate row index
 ...
 m.stack_init(size, entries);           // Initialise stack
 ...
 for (int i = 0; i < number; ++i) {     // Initialise array
   values[i] = ...                      // ... set values
   rows[i]   = ...                      // ... set row indices
 }
 ...
 m.add_col(values,rows,number,col);     // Add array
 ...
 m.stack_destroy();                     // Flush and destory stack
 ...
 delete [] values;                      // Free array
 delete [] rows;
\end{verbatim}

The method {\tt add\_col} calls the method {\tt stack\_push\_column}
for stack filling.
{\tt add\_col} is more general than {\tt stack\_push\_column} in that 
it decides which of stack- or direct filling is more adequate.
In particular, {\tt stack\_push\_column} may refuse pushing a column 
onto the stack if there is not enough space.
In that case, {\tt stack\_push\_column} returns a non-zero value that 
corresponds to the number of non-zero elements in the vector that 
should be added.
However, it is recommended to not use {\tt stack\_push\_column} and 
call instead {\tt add\_col}.

The method {\tt stack\_destroy} is used to flush and destroy the
stack. 
After this call the stack memory is liberated.
If the stack should be flushed without destroying it, the method
{\tt stack\_flush} may be used:
\begin{verbatim}
 m.stack_init(size, entries);           // Initialise stack
 ...
 m.add_col(vector,col);                 // Add columns
 ...
 m.stack_flush();                       // Simply flush stack
\end{verbatim}
Once flushed, the stack can be filled anew.

Note that stack flushing is not automatic!
This means, if one trys to use a matrix for calculs without flushing, 
the calculs may be wrong.
{\bf If a stack is used for filling, always flush the stack before using 
the matrix.}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Glossary
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\clearpage
\section{Glossary}
\begin{itemize}
\item[] {\bf \cfitsio}\break
  Library of C and Fortran subroutines for reading and writing data files in FITS data format\break
  (\url{http://heasarc.gsfc.nasa.gov/fitsio/}).
\item[] {\bf FITS\label{gloss:fits}}\break
  Flexible Image Transport System (\url{http://fits.gsfc.nasa.gov/}).
\item[] {\bf FTOOLS}\break
  Collection of utility programs to create, examine, or modify data files in the FITS data format\break
  (\url{http://heasarc.gsfc.nasa.gov/ftools/}).
\item[] {\bf GNU}\break
  A free Unix-like operating system (\url{http://www.gnu.org/}).
\item[] {\bf HEASARC}\break
  High Energy Astrophysics Science Archive Research Center (\url{http://heasarc.gsfc.nasa.gov/}).
\item[] {\bf Python}\break
  Dynamic programming language that is used in a wide variety of application domains\break
  (\url{http://www.python.org/}).
\end{itemize}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Index
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\clearpage
\section{Index}
\printindex


\end{document} 
