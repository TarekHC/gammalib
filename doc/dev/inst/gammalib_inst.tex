%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% GammaLib Instrument Specific Interface
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Definitions for manual package
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newcommand{\task}{\mbox{GammaLib}}
\newcommand{\this}{\mbox{\tt \task}}
\newcommand{\shorttype}{\mbox{INST}}
\newcommand{\doctype}{\mbox{Instrument specific interface}}
\newcommand{\version}{\mbox{draft}}
\newcommand{\calendar}{\mbox{27 May 2010}}
\newcommand{\auth}{\mbox{J\"urgen Kn\"odlseder}}
\newcommand{\approv}{\mbox{J\"urgen Kn\"odlseder}}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Document definition
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\documentclass{article}[12pt,a4]
\usepackage{epsfig}
\usepackage{manual}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Begin of document body
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{document}
\frontpage


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Introduction
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Introduction}

The present document describes the instrument specific interface of the \this\ toolbox
and provides guideslines of how to add a new interface to the toolbox.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Instrument response
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Instrument response}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Response model}

The general instrument response function
$R(\vec{p'}, E', t' | \vec{d}, \vec{p}, E, t)$
provides the effective detection area per time, energy and solid angle
(in units of cm$^2$ s$^{-1}$ MeV$^{-1}$ sr$^{-1}$) 
for measuring a photon at position $\vec{p'}$ with an energy of $E'$ and at the time $t'$ if it 
arrives on the instrument that is pointed towards $\vec{d}$ from direction $\vec{p}$ with an 
energy of $E$ at time $t$.
Note that $\vec{p'}$ is not necessarily a measured arrival direction, but it can also be
a detector coordinate.
$R(\vec{p'}, E', t' | \vec{d}, \vec{p}, E, t)$ is factorised following
\begin{equation}
R(\vec{p'}, E', t' | \vec{d}, \vec{p}, E, t) = 
A_{\rm eff}(\vec{d}, \vec{p}, E, t) \times
PSF(\vec{p'} | \vec{d}, \vec{p}, E, t) \times
E_{\rm disp}(E' | \vec{d}, \vec{p}, E, t) \times
T_{\rm disp}(t' | \vec{d}, \vec{p}, E, t)
\label{eq:rspfact}
\end{equation}
where
\begin{itemize}
\item[] $A_{\rm eff}(\vec{d}, \vec{p}, E, t)$ is the effective area (in units of counts photons$^{-1}$cm$^2$),
\item[] $PSF(\vec{p'} | \vec{d}, \vec{p}, E, t)$ is the point spread function (in units of sr$^{-1}$),
\item[] $E_{\rm disp}(E' | \vec{d}, \vec{p}, E, t)$ is the energy dispersion (in units of MeV$^{-1}$), and
\item[] $T_{\rm disp}(t' | \vec{d}, \vec{p}, E, t)$ is the time dispersion (in units of s$^{-1}$).
\end{itemize}
Note that $A_{\rm eff}$ includes also the livetime fraction.
Assuming that the photon intensity received from a gamma-ray source is described by
the source model $S(\vec{p}, E, t)$ (in units of photons cm$^{-2}$ s$^{-1}$ MeV$^{-1}$ sr$^{-1}$)
the probability of measuring an event at position $\vec{p'}$ with an
energy of $E'$ at the time $t'$ from the source is given by
\begin{equation}
N(\vec{p'}, E', t') = \int_{0}^{t'+\Delta t} \int_{E'-\Delta E}^{\infty} \int_{\Omega} 
S(\vec{p}, E, t) \times R(\vec{p'}, E', t' | \vec{d}, \vec{p}, E, t) \, {\rm d}\vec{p} \, {\rm d}E \,{\rm d}t
\label{eq:model}
\end{equation}
(in units of counts s$^{-1}$ MeV$^{-1}$ sr$^{-1}$).
The terms $\Delta t$ and $\Delta E$ account for the statistical jitter related to the measurement
process and are of the order of a few time the rms in the time and energy measurements.
In the case of no time dispersion, $T_{\rm disp}(t' | \vec{d}, \vec{p}, E, t)$ becomes a $\delta$-function
and Eq.~(\ref{eq:model}) reduces to 
\begin{equation}
N(\vec{p'}, E', t') = \int_{E'-\Delta E}^{\infty} \int_{\Omega} 
S(\vec{p}, E, t) \times A_{\rm eff}(\vec{d}, \vec{p}, E, t) \times
PSF(\vec{p'} | \vec{d}, \vec{p}, E, t) \times
E_{\rm disp}(E' | \vec{d}, \vec{p}, E, t) 
\, {\rm d}\vec{p} \, {\rm d}E \, .
\end{equation}
Since for many astrophysical sources $S(\vec{p}, E, t)$ drops quickly with energy, only
photons near $E'$ contribute effectively to the integral.
For this reason, energy dispersion can also often be neglected, and also
$E_{\rm disp}(E' | \vec{d}, \vec{p}, E, t)$ can be approximated by a $\delta$-function,
leading to
\begin{equation}
N(\vec{p'}, E', t') = \int_{\Omega} S(\vec{p}, E, t) \times A_{\rm eff}(\vec{d}, \vec{p}, E, t) \times
PSF(\vec{p'} | \vec{d}, \vec{p}, E, t) \, {\rm d}\vec{p} \, .
\end{equation}
These simplifications may be considered when implementing the computation of
$N(\vec{p'}, E', t')$ for a specific instrument.

A special type of source model is given by the factorisation
\begin{equation}
S(\vec{p}, E, t) = M(\vec{p}) \times P(E) \times V(t)
\end{equation}
where
\begin{itemize}
\item[] $M(\vec{p})$ is a map of the intensity distribution (in units of sr$^{-1}$),
\item[] $P(E)$ is the source spectrum (in units of photons cm$^{-2}$ s$^{-1}$ MeV$^{-1}$), and
\item[] $V(t)$ is a source modulation function (unitless).
\end{itemize}

The \this\ implementation of the response function and parameters is summarised in 
Table \ref{tab:respar}.

%%% Response parameters %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{table}[!h]
\caption{\this\ implementation of the response function and parameters. 
The last column indicates if the function or parameter requires an
instrument specific implementation (the corresponding class is an abstract base class
from which the implementation needs to be derived).
\label{tab:respar}}
\begin{center}
\begin{tabular}{lccc}
\hline
\hline
\noalign{\smallskip}
Response function or parameter & Designation & Class (::method) & Instrument specific \\
\noalign{\smallskip}
\hline
\noalign{\smallskip}
Response function & $R$ & {\tt GResponse::irf()} & possible \\
Effective area & $A_{\rm eff}$ & {\tt GResponse::aeff()} & {\bf yes} \\
Point spread function & $PSF$ & {\tt GResponse::psf()} & {\bf yes} \\
Energy dispersion & $E_{\rm disp}$ & {\tt GResponse::edisp()} & {\bf yes} \\
Time dispersion & $T_{\rm disp}$ & {\tt GResponse::tdisp()} & {\bf yes} \\
Probability of measuring a photon & $N$ & {\tt GEvent::model()} & {\bf yes} \\
Source model & $S$ & {\tt GModels}, {\tt GModel} & no \\ 
Measured location of photon & $\vec{p'}$ & {\tt GInstDir} & {\bf yes} \\
Measured energy of photon & $E'$ & {\tt GEnergy} & no \\
Measured arrival time & $t'$ & {\tt GTime} & no \\
Instrument pointing & $d$ & {\tt GPointing} & {\bf yes} \\
True arrival direction of photon & $\vec{p}$ & {\tt GSkyDir} & no \\
True energy of photon & $E$ & {\tt GEnergy} & no \\
True arrival time of photon & $t$ & {\tt GTime} & no \\
\noalign{\smallskip}
\hline
\end{tabular}
\end{center}
\end{table}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Response class {\tt GResponse}}

An instrument specific response class {\tt GXXXResponse} (where {\tt XXX} is the instrument code)
needs to be provided that derives from the abstract base class {\tt GResponse}.
Below are the methods that need to be implemented in {\tt GXXXResponse} and their interface
definition.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{{\tt GXXXResponse::irf()}}

Following the factorisation of the response (cf.~Eq.~\ref{eq:rspfact}) the standard implementation
of the {\tt GResponse::irf()} is given by the following code:
\begin{verbatim}
double GResponse::irf(const GInstDir& obsDir, const GEnergy& obsEng, const GTime& obsTime,
                      const GSkyDir& srcDir, const GEnergy& srcEng, const GTime& srcTime,
                      const GPointing& pnt)
{
    double irf = psf(obsDir, obsEng, obsTime, srcDir, srcEng, srcTime, pnt);
    irf *= aeff(obsDir, obsEng, obsTime, srcDir, srcEng, srcTime, pnt);
    irf *= edisp(obsDir, obsEng, obsTime, srcDir, srcEng, srcTime, pnt);
    irf *= tdisp(obsDir, obsEng, obsTime, srcDir, srcEng, srcTime, pnt);
    return irf;
}
\end{verbatim}
This code is implemented in the {\tt GResponse::irf()} base class as a {\tt virtual} member and
needs not to be implemented in the derived instrument specific class.
However, an instrument specific version may be provided as for example {\tt tdisp()} is rarely
needed and also {\tt edisp()} is often not used.
By omitting these terms a more efficient response calculation may be provided.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{{\tt GXXXResponse::aeff()}}

Needs to be implemented and needs to return effective area in units of cm$^2$.
Interface:
\begin{verbatim}
double GXXXResponse::aeff(const GInstDir& obsDir, const GEnergy& obsEng, const GTime& obsTime,
                          const GSkyDir& srcDir, const GEnergy& srcEng, const GTime& srcTime,
                          const GPointing& pnt)
\end{verbatim}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{{\tt GXXXResponse::psf()}}

Needs to be implemented and needs to return point spread function in units of sr$^{-1}$.
Interface:
\begin{verbatim}
double GXXXResponse::psf(const GInstDir& obsDir, const GEnergy& obsEng, const GTime& obsTime,
                         const GSkyDir& srcDir, const GEnergy& srcEng, const GTime& srcTime,
                         const GPointing& pnt)
\end{verbatim}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{{\tt GXXXResponse::edisp()}}

Needs to be implemented and needs to return energy dispersion in units of MeV$^{-1}$.
Interface:
\begin{verbatim}
double GXXXResponse::edisp(const GInstDir* obsDir, const GEnergy& obsEng, const GTime& obsTime,
                          const GSkyDir& srcDir, const GEnergy& srcEng, const GTime& srcTime,
                          const GPointing* pnt)
\end{verbatim}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{{\tt GXXXResponse::tdisp()}}

Needs to be implemented and needs to return time dispersion in units of s$^{-1}$.
Interface:
\begin{verbatim}
double GXXXResponse::tdisp(const GInstDir& obsDir, const GEnergy& obsEng, const GTime& obsTime,
                          const GSkyDir& srcDir, const GEnergy& srcEng, const GTime& srcTime,
                          const GPointing& pnt)
\end{verbatim}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{{\tt GXXXInstDir}}

Needs to be implemented.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{{\tt GXXXPointing}}

Needs to be implemented.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Source model}

The following methods are to be implemented to evaluate $N(\vec{p'}, E', t')$.
Note that the integral of Eq.~(\ref{eq:model}) could be implemented
generically.

\begin{verbatim}
GXXXEventAtom::model(GModels& models);
GXXXEventAtom::model(GModels& models, GVector* gradient);
GXXXEventBin::model(GModels& models);
GXXXEventBin::model(GModels& models, GVector* gradient);
\end{verbatim}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Instrument data
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Instrument data}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Events}

Data are comprised of events.
The are two types of events: event atoms and event bins.
Events are combined together in {\tt GEvents}.
{\tt GEvents} implements an iteration that allows iterating over event atoms or event bins
(the differenciation between both is transparent for the user).
{\tt GEvents} has an abstract method {\tt pointer(int index)} that returns a pointer to an
event.
This method, which has to be implement for each instrument, assigns information to
all events.
Note that in general, only a single event can be accessed at a time (any subsequent
class to the {\tt pointer()} method makes the old pointer invalid.

\end{document}
